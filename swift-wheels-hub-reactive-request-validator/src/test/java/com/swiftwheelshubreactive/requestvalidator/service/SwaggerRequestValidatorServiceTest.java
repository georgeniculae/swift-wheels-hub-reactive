package com.swiftwheelshubreactive.requestvalidator.service;

import com.swiftwheelshubreactive.dto.IncomingRequestDetails;
import com.swiftwheelshubreactive.dto.RequestValidationReport;
import com.swiftwheelshubreactive.requestvalidator.model.SwaggerFile;
import com.swiftwheelshubreactive.requestvalidator.util.TestUtils;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.redis.core.ReactiveRedisOperations;
import org.springframework.data.redis.core.ReactiveValueOperations;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class SwaggerRequestValidatorServiceTest {

    @InjectMocks
    private SwaggerRequestValidatorService swaggerRequestValidatorService;

    @Mock
    private ReactiveRedisOperations<String, SwaggerFile> reactiveRedisOperations;

    @Mock
    private ReactiveValueOperations<String, SwaggerFile> reactiveValueOperations;

    @Test
    void validateRequestTest_success() {
        IncomingRequestDetails incomingRequestDetails =
                TestUtils.getResourceAsJson("/data/IncomingRequestDetails.json", IncomingRequestDetails.class);

        RequestValidationReport validationReport =
                TestUtils.getResourceAsJson("/data/RequestValidationReport.json", RequestValidationReport.class);

        String content = "{\"openapi\":\"3.0.1\",\"info\":{\"title\":\"OpenAPI definition\",\"version\":\"v0\"},\"servers\":[{\"url\":\"http://172.30.64.1:55990/agency\",\"description\":\"Generated server url\"}],\"paths\":{\"/rental-offices/{id}\":{\"get\":{\"tags\":[\"rental-office-controller\"],\"operationId\":\"findRentalOfficeById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/RentalOfficeRequest\"}}}}}},\"put\":{\"tags\":[\"rental-office-controller\"],\"operationId\":\"updateRentalOffice\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/RentalOfficeRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/RentalOfficeRequest\"}}}}}},\"delete\":{\"tags\":[\"rental-office-controller\"],\"operationId\":\"deleteRentalOfficeById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\"}}}},\"/employees/{id}\":{\"get\":{\"tags\":[\"employee-controller\"],\"operationId\":\"findEmployeeById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}}}}},\"put\":{\"tags\":[\"employee-controller\"],\"operationId\":\"updateEmployee\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}}}}},\"delete\":{\"tags\":[\"employee-controller\"],\"operationId\":\"deleteEmployeeById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\"}}}},\"/cars/{id}\":{\"get\":{\"tags\":[\"car-controller\"],\"operationId\":\"findCarById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}},\"put\":{\"tags\":[\"car-controller\"],\"operationId\":\"updateCar\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}},\"delete\":{\"tags\":[\"car-controller\"],\"operationId\":\"deleteCarById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\"}}}},\"/cars/{id}/update-after-return\":{\"put\":{\"tags\":[\"car-controller\"],\"operationId\":\"updateCarWhenBookingIsClosed\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/CarUpdateDetails\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}},\"/cars/{id}/change-status\":{\"put\":{\"tags\":[\"car-controller\"],\"operationId\":\"updateCarStatus\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}},{\"name\":\"carState\",\"in\":\"query\",\"required\":true,\"schema\":{\"type\":\"string\",\"enum\":[\"NOT_AVAILABLE\",\"BROKEN\",\"IN_REPAIR\",\"IN_SERVICE\",\"AVAILABLE\"]}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}},\"/cars/update-statuses\":{\"put\":{\"tags\":[\"car-controller\"],\"operationId\":\"updateCarsStatus\",\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/UpdateCarRequest\"}}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}}},\"/branches/{id}\":{\"get\":{\"tags\":[\"branch-controller\"],\"operationId\":\"findBranchById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/BranchRequest\"}}}}}},\"put\":{\"tags\":[\"branch-controller\"],\"operationId\":\"updateBranch\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/BranchRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/BranchRequest\"}}}}}},\"delete\":{\"tags\":[\"branch-controller\"],\"operationId\":\"deleteBranchById\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\"}}}},\"/rental-offices\":{\"get\":{\"tags\":[\"rental-office-controller\"],\"operationId\":\"findAllRentalOffices\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/RentalOfficeRequest\"}}}}}}},\"post\":{\"tags\":[\"rental-office-controller\"],\"operationId\":\"addRentalOffice\",\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/RentalOfficeRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/RentalOfficeRequest\"}}}}}}},\"/employees\":{\"get\":{\"tags\":[\"employee-controller\"],\"operationId\":\"findAllEmployees\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}}}}}},\"post\":{\"tags\":[\"employee-controller\"],\"operationId\":\"addEmployee\",\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}}}}}},\"/cars\":{\"get\":{\"tags\":[\"car-controller\"],\"operationId\":\"findAllCars\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}},\"post\":{\"tags\":[\"car-controller\"],\"operationId\":\"addCar\",\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}},\"/cars/upload\":{\"post\":{\"tags\":[\"car-controller\"],\"operationId\":\"uploadCars\",\"requestBody\":{\"content\":{\"multipart/form-data\":{\"schema\":{\"required\":[\"file\"],\"type\":\"object\",\"properties\":{\"file\":{\"type\":\"string\",\"format\":\"binary\"}}}}}},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}}},\"/cars/add\":{\"post\":{\"tags\":[\"car-controller\"],\"operationId\":\"addCars\",\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}}},\"/branches\":{\"get\":{\"tags\":[\"branch-controller\"],\"operationId\":\"findAllBranches\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/BranchRequest\"}}}}}}},\"post\":{\"tags\":[\"branch-controller\"],\"operationId\":\"addBranch\",\"requestBody\":{\"content\":{\"application/json\":{\"schema\":{\"$ref\":\"#/components/schemas/BranchRequest\"}}},\"required\":true},\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/BranchRequest\"}}}}}}},\"/rental-offices/count\":{\"get\":{\"tags\":[\"rental-office-controller\"],\"operationId\":\"countRentalOffices\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}}}}}},\"/employees/count\":{\"get\":{\"tags\":[\"employee-controller\"],\"operationId\":\"countEmployees\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}}}}}},\"/employees/branch/{id}\":{\"get\":{\"tags\":[\"employee-controller\"],\"operationId\":\"findEmployeesByBranchId\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/EmployeeRequest\"}}}}}}}},\"/cars/{id}/availability\":{\"get\":{\"tags\":[\"car-controller\"],\"operationId\":\"getAvailableCar\",\"parameters\":[{\"name\":\"id\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}},\"/cars/make/{make}\":{\"get\":{\"tags\":[\"car-controller\"],\"operationId\":\"findCarsByMake\",\"parameters\":[{\"name\":\"make\",\"in\":\"path\",\"required\":true,\"schema\":{\"type\":\"string\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/components/schemas/CarRequest\"}}}}}}}},\"/cars/count\":{\"get\":{\"tags\":[\"car-controller\"],\"operationId\":\"countCars\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}}}}}},\"/branches/count\":{\"get\":{\"tags\":[\"branch-controller\"],\"operationId\":\"countBranches\",\"responses\":{\"200\":{\"description\":\"OK\",\"content\":{\"*/*\":{\"schema\":{\"type\":\"integer\",\"format\":\"int64\"}}}}}}}},\"components\":{\"schemas\":{\"RentalOfficeRequest\":{\"required\":[\"contactAddress\",\"name\"],\"type\":\"object\",\"properties\":{\"id\":{\"type\":\"integer\",\"format\":\"int64\"},\"name\":{\"type\":\"string\"},\"contactAddress\":{\"type\":\"string\"},\"phoneNumber\":{\"type\":\"string\"}}},\"EmployeeRequest\":{\"required\":[\"firstName\",\"jobPosition\",\"lastName\"],\"type\":\"object\",\"properties\":{\"id\":{\"type\":\"integer\",\"format\":\"int64\"},\"firstName\":{\"type\":\"string\"},\"lastName\":{\"type\":\"string\"},\"jobPosition\":{\"type\":\"string\"},\"workingBranchId\":{\"type\":\"integer\",\"format\":\"int64\"}}},\"CarRequest\":{\"required\":[\"make\",\"model\"],\"type\":\"object\",\"properties\":{\"id\":{\"type\":\"integer\",\"format\":\"int64\"},\"make\":{\"type\":\"string\"},\"model\":{\"type\":\"string\"},\"bodyCategory\":{\"type\":\"string\",\"enum\":[\"HATCHBACK\",\"SEDAN\",\"SUV\",\"COUPE\",\"CONVERTIBLE\",\"WAGON\",\"VAN\"]},\"yearOfProduction\":{\"type\":\"integer\",\"format\":\"int32\"},\"color\":{\"type\":\"string\"},\"mileage\":{\"type\":\"integer\",\"format\":\"int32\"},\"carState\":{\"type\":\"string\",\"enum\":[\"NOT_AVAILABLE\",\"BROKEN\",\"IN_REPAIR\",\"IN_SERVICE\",\"AVAILABLE\"]},\"amount\":{\"type\":\"number\",\"format\":\"double\"},\"originalBranchId\":{\"type\":\"integer\",\"format\":\"int64\"},\"actualBranchId\":{\"type\":\"integer\",\"format\":\"int64\"},\"urlOfImage\":{\"type\":\"string\"}}},\"CarUpdateDetails\":{\"type\":\"object\",\"properties\":{\"carId\":{\"type\":\"integer\",\"format\":\"int64\"},\"carState\":{\"type\":\"string\",\"enum\":[\"NOT_AVAILABLE\",\"BROKEN\",\"IN_REPAIR\",\"IN_SERVICE\",\"AVAILABLE\"]},\"receptionistEmployeeId\":{\"type\":\"integer\",\"format\":\"int64\"}}},\"UpdateCarRequest\":{\"type\":\"object\",\"properties\":{\"carId\":{\"type\":\"integer\",\"format\":\"int64\"},\"carState\":{\"type\":\"string\",\"enum\":[\"NOT_AVAILABLE\",\"BROKEN\",\"IN_REPAIR\",\"IN_SERVICE\",\"AVAILABLE\"]}}},\"BranchRequest\":{\"required\":[\"name\"],\"type\":\"object\",\"properties\":{\"id\":{\"type\":\"integer\",\"format\":\"int64\"},\"name\":{\"type\":\"string\"},\"address\":{\"type\":\"string\"},\"rentalOfficeId\":{\"type\":\"integer\",\"format\":\"int64\"}}}}}}";

        SwaggerFile swaggerFile = SwaggerFile.builder()
                .id("agency")
                .swaggerContent(content)
                .build();

        when(reactiveRedisOperations.opsForValue()).thenReturn(reactiveValueOperations);
        when(reactiveValueOperations.get(anyString())).thenReturn(Mono.just(swaggerFile));

        swaggerRequestValidatorService.validateRequest(incomingRequestDetails)
                .as(StepVerifier::create)
                .expectNext(validationReport)
                .verifyComplete();
    }

}
